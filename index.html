<!DOCTYPE HTML>
<html lang="en" data-bs-theme="dark">
<head>
    <title>DICOM Tag Browser</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/bootstrap-icons.min.css">
    <style>

        #dropZone {
            height: 86vh;
            width: 100%;
            overflow: auto;
        }

        #dicomInfo{
            position: absolute;
        }

        #dicomInfo p{
            color: white;
            font-size: 10px;
            height: 1px;
        }

        .pointer {
            cursor: pointer;
            color: #00c2ff;
        }

        #fileInput{
            width: 95%;
        }

        td i{
            display: none;
        }

        td:hover i{
            display: inline;
        }

        td[show="copied"] i:hover{
            cursor: pointer;
            color: #00c2ff;
        }


    </style>

</head>
<body style="overflow: hidden;">
<div class="mx-2">
    <div class="row">
        <div class="col-md-4">
            <div style="margin-top: 10%;" class="heading mx-5">
                <h3>DICOM Inspector</h3>
            </div>
            <div class="mx-5" style="margin-top: 5%;">
                <select id="seriesSelect" onchange="setNewSeries(this.value)" class="form-select">

                </select>
            </div>
            <div style="width:100%;height:65%; margin-left:2%; margin-top:6%;color: white;display:inline-block;" class='disable-selection noIbar' unselectable='on' onselectstart='return false;' onmousedown='return false;'>
                <div id="dicomInfo"></div>
                <div id="dicomImage" style="width:100%;height:80%"></div>
            </div>
            <div id="slider-div" style="display: none;" class="row mx-3">
                <div class="col-md-1 ml-5" id="currentSlice">1</div>
                <div class="col-md-10">
                    <input type="range" id="dicomSlice" min="1" max="1" value="1" class="form-range" />
                </div>
                
                <div class="col-md-1" id="totalSlice">1</div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row mt-5">
                <input type="text" id="fileInput" class="form-control" onkeydown="performSearch(this.value)" placeholder="Search Tags..." />
            </div>
    
            <div class="row">
                <div class="col-md-12">
                    <div id="dropZone">
                        <div style="margin-top:225px;margin-left: 10%;  user-select: none;"><h3><i class="bi bi-download"></i>   Drag DICOM file here</h3></div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <div id="status" style="display: none;" class="alert alert-success">
        <div id="statusText">
            Status: Ready (no file loaded)
        </div>
        <ul id="warnings">

        </ul>
    </div>

</div>
<div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modal-title" class="modal-title">Sequence View</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="modalContent"></div>
        </div>
      </div>
    </div>
  </div>
</body>

<script src="/js/DicomTags.js"></script>
<script src="/js/hammer.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/dicomParser.min.js"></script>
<script src="/js/cornerstone.js"></script>
<script src="/js/cornerstoneMath.min.js"></script>
<script src="/js/cornerstoneTools.js"></script>
<script src="/js/cornerstoneWADOImageLoader.bundle.min.js"></script>
<script src="/js/app.js"></script>
<script src="/js/initializeWebWorkers.js"></script>
<script src="js/jquery-3.7.1.min.js"></script>


<script>

    function isASCII(str) {
        return /^[\x00-\x7F]*$/.test(str);
    }

    var modalData = {};
    var images = {};
    var currentSeries = "";
    var clipboardHistory = {};

    var myModal = new bootstrap.Modal(document.getElementById('myModal'));
    var dicomImage = document.getElementById('dicomImage');
    cornerstone.enable(dicomImage);
    var loaded = false;
    var totalSliceElement = $("#totalSlice")[0]
    var currentSliceElement = $("#currentSlice")[0]
    var imageSlider = $($("#dicomSlice")[0])

    function formatDicomTag(tag) {
        const cleanedTag = tag.startsWith('x') ? tag.slice(1) : tag;
        const group = cleanedTag.slice(0, 4).toUpperCase();
        const element = cleanedTag.slice(4).toUpperCase();
        const tagFormatted = `(${group},${element})`;
        return [tagFormatted, DicomTags[tagFormatted] ?? 'Private Tag'];
    }

    function dumpDataSet(dataSet, output, metaDetails) {
        
        try {
            output.push(`<table class="table table-striped">
                <thead>
                    <tr>
                        <th>Tag</th>
                        <th>Name</th>
                        <th>Length</th>
                        <th>VR</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>`)
            for (var propertyName in dataSet.elements) {
                if(propertyName === 'xfffee00d') {
                    continue;
                }
                var text = "<tr>"
                var element = dataSet.elements[propertyName];

                var tagData = formatDicomTag(element.tag);

                text += "<td show='copy'>" + tagData[0] + "</td>";
                text += "<td show='copy'>" + tagData[1] + "</td>";

                if (element.hadUndefinedLength) {
                    text += "<td>(-1)</td>";
                }else{
                    text += "<td>" + element.length + "</td>";
                }

                if (element.vr) {
                    text += "<td>" + element.vr + "</td>";
                }

                var color = 'black';
                text += "<td show='copy'>"
                if (element.items) {
                    output.push(text);
                    var itemNumber = 0;
                    element.items.forEach(function (item) {
                        
                        var itemsHTML = [];
                        let newMetaDetails = {};
                        dumpDataSet(item.dataSet, itemsHTML, newMetaDetails);
                        var formattedItemTag = formatDicomTag(item.tag);

                        var uuid = generateUUID();
                        modalData[uuid] = {
                            html: itemsHTML.join(''),
                            originalTagData: tagData,
                            baseTagData: formattedItemTag,
                            itemNumber: itemNumber
                        };
                        
                        output.push('<p class="pointer" onclick="openModal(`'+ uuid +'`)">SEQ #' + itemNumber++ + ' ' + `${formattedItemTag[0]}` + '</p>')
                    });
                }
                else if (element.fragments) {
                    output.push('' + text);
                    var itemNumber = 0;
                    element.fragments.forEach(function (fragment) {
                        var basicOffset;
                        if(element.basicOffsetTable) {
                            basicOffset = element.basicOffsetTable[itemNumber];
                        }

                        var str = 'Fragment #' + itemNumber++ + ' offset = ' + fragment.offset;
                        str += '(' + basicOffset + ')';
                        str += '; length = ' + fragment.length + '';
                        output.push(str);
                    });
                }
                else {
                    if (element.length < 128) {
                        var numberValue = 0;
                        if (element.length === 2) {
                            numberValue = dataSet.uint16(propertyName);
                            text += numberValue;
                        }
                        else if (element.length === 4) {
                            numberValue = dataSet.uint32(propertyName);
                            text += numberValue;
                        }

                        var str = dataSet.string(propertyName);
                        var stringIsAscii = isASCII(str);

                        if (stringIsAscii) {
                            if (str !== undefined) {
                                if(numberValue !== 0) {
                                    text += ' - ';
                                }
                                text += '"' + str + '"';
                                filterDetails(tagData[0], str, metaDetails);
                            }
                        }

                        
                        else {
                            if (element.length !== 2 && element.length !== 4) {
                                color = '#C8C8C8';
                                text += "binary data";
                            }
                        }

                        if (element.length === 0) {
                            color = '#C8C8C8';
                        }

                    }
                    else {
                        color = '#C8C8C8';
                        text += "data too long to show";
                    }

                    output.push(text);

                }
                text += "</td>"
                text += "</tr>"
            }

            output.push('</tbody></table>')
        } catch(err) {
            var ex = {
                exception: err,
                output: output
            }
            throw ex;
        }
    }

    openModal = function(uuid) {
        var modalContent = document.getElementById('modalContent');
        var sequenceContent = modalData[uuid];
        modalContent.innerHTML = sequenceContent.html;
        $('#modal-title')[0].innerHTML = `Sequence #${sequenceContent.itemNumber} - ${sequenceContent.originalTagData.join(" - ")}`;
        showCopyIcon();
        myModal.show();
    }

    async function setImage(index){
        let image = images[currentSeries][index]
        loadAndViewImage(image);
        await dumpFile(image.file);
    }

    async function onSliderChange(event){
        let value = imageSlider.val();
        currentSliceElement.innerHTML = value;

        let newIndex = value - 1;
        await setImage(newIndex);
    }

    function sliderLeft(){
        if(parseInt(imageSlider.val()) > 1){
            imageSlider.val(parseInt(imageSlider[0].value) - 1);
            onSliderChange("input");
        }
    }

    function SliderRight(){
        if(parseInt(imageSlider.val()) < parseInt(totalSliceElement.innerHTML)){
            imageSlider.val(parseInt(imageSlider[0].value) + 1);
            onSliderChange("input");
        }
    }

    window.onload = function(){
        // Setup the dnd listeners.
        var body = document.getElementsByTagName('body')[0];
        body.addEventListener('dragover', handleDragOver, false);
        body.addEventListener('drop', handleFileSelect, false);


        imageSlider.on("input", onSliderChange);

        // On arrow left or right change imageSlider value
        document.onkeydown = function(e) {
            switch (e.keyCode) {
                case 37:
                    if(parseInt(imageSlider.val()) > 1){
                        imageSlider.val(parseInt(imageSlider[0].value) - 1);
                        onSliderChange("input");
                    }
                    break;
                case 39:
                    if(parseInt(imageSlider.val()) < parseInt(totalSliceElement.innerHTML)){
                        imageSlider.val(parseInt(imageSlider[0].value) + 1);
                        onSliderChange("input");
                    }
                    break;
            }
        };

        // dicomImage on mousewheel call sliderLeft or SliderRight
        dicomImage.addEventListener('wheel', function(e){
            if(e.deltaY > 0){
                sliderLeft();
            }else{
                SliderRight();
            }
        });
        
    }

    



</script>
</html>