<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>

        #dropZone {
            height: 90vh;
            width: 100%;
            background-color: #F0F0F0;
            overflow: auto;
            margin-top: 25px;
        }


    </style>

</head>
<body>
<div class="container">

    <div class="page-header mt-5">
        <h3>DICOM Inspector</h3>
    </div>

    <div class="row mt-3">
        <input type="text" id="fileInput" class="form-control" onkeydown="performSearch(this.value)" placeholder="Search Tags..." />
    </div>

    <div class="row">
        <div class="col-md-12">
            <div id="dropZone">
                <div class="text-center" style="margin-top:225px;"><h3>Drag DICOM file here</h3></div>

            </div>
        </div>
    </div>

    <div id="status" style="display: none;" class="alert alert-success">
        <div id="statusText">
            Status: Ready (no file loaded)
        </div>
        <ul id="warnings">

        </ul>
    </div>

</div>
<div class="modal fade" id="myModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Sequence View</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="modalContent"></div>
        </div>
      </div>
    </div>
  </div>
</body>

<script src="/js/DicomTags.js"></script>
<script src="/js/dicomParser.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="js/jquery-3.7.1.min.js"></script>


<script>

    function isASCII(str) {
        return /^[\x00-\x7F]*$/.test(str);
    }

    var modalData = {};

    var myModal = new bootstrap.Modal(document.getElementById('myModal'));


    function generateUUID() {
        return crypto.randomUUID();
    }

    function performSearch(value){
        var table = document.querySelector('tbody');
        var tr = table.getElementsByTagName('tr');
        for (const row of tr) {
            const td = row.getElementsByTagName('td');
            let found = false;
            for (const cell of td) {
                if (cell.innerHTML.toUpperCase().indexOf(value.toUpperCase()) > -1) {
                    found = true;
                    break;
                }
            }
            row.style.display = found ? '' : 'none';
        }
    }

    function formatDicomTag(tag) {
        const cleanedTag = tag.startsWith('x') ? tag.slice(1) : tag;
        const group = cleanedTag.slice(0, 4).toUpperCase();
        const element = cleanedTag.slice(4).toUpperCase();
        const tagFormatted = `(${group},${element})`;
        return [tagFormatted, DicomTags[tagFormatted]]
    }
    function dumpDataSet(dataSet, output) {
        
        try {
            output.push(`<table class="table">
                <thead>
                    <tr>
                        <th>Tag</th>
                        <th>Name</th>
                        <th>Length</th>
                        <th>VR</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>`)
            for (var propertyName in dataSet.elements) {
                var text = "<tr>"
                var element = dataSet.elements[propertyName];

                var tagData = formatDicomTag(element.tag);

                text += "<td>" + tagData[0] + "</td>";
                text += "<td>" + tagData[1] + "</td>";

                if (element.hadUndefinedLength) {
                    text += "<td>(-1)</td>";
                }else{
                    text += "<td>" + element.length + "</td>";
                }

                if (element.vr) {
                    text += "<td>" + element.vr + "</td>";
                }

                var color = 'black';
                text += "<td>"
                if (element.items) {
                    output.push(text);
                    var itemNumber = 0;
                    element.items.forEach(function (item) {
                        
                        var itemsHTML = [];
                        dumpDataSet(item.dataSet, itemsHTML);
                        
                        var uuid = generateUUID();
                        modalData[uuid] = itemsHTML.join('');
                        var formattedItemTag = formatDicomTag(item.tag);
                        output.push('<p onclick="openModal(`'+ uuid +'`)">Item #' + itemNumber++ + ' ' + `${formattedItemTag[0]}` + '</p>')
                    });
                }
                else if (element.fragments) {
                    output.push('' + text);
                    var itemNumber = 0;
                    element.fragments.forEach(function (fragment) {
                        var basicOffset;
                        if(element.basicOffsetTable) {
                            basicOffset = element.basicOffsetTable[itemNumber];
                        }

                        var str = 'Fragment #' + itemNumber++ + ' offset = ' + fragment.offset;
                        str += '(' + basicOffset + ')';
                        str += '; length = ' + fragment.length + '';
                        output.push(str);
                    });
                }
                else {
                    if (element.length < 128) {
                        var numberPresent = false;
                        if (element.length === 2) {
                            text += dataSet.uint16(propertyName);
                            numberPresent = true;
                        }
                        else if (element.length === 4) {
                            text += dataSet.uint32(propertyName);
                            numberPresent = true;
                        }
                        var str = dataSet.string(propertyName);
                        var stringIsAscii = isASCII(str);

                        if (stringIsAscii) {
                            if (str !== undefined && !numberPresent) {
                                text += '"' + str + '"';
                            }
                        }
                        else {
                            if (element.length !== 2 && element.length !== 4) {
                                color = '#C8C8C8';
                                text += "binary data";
                            }
                        }

                        if (element.length === 0) {
                            color = '#C8C8C8';
                        }

                    }
                    else {
                        color = '#C8C8C8';
                        text += "data too long to show";
                    }

                    output.push('<p style="color:' + color + ';">' + text + '</p>');

                }
                text += "</td>"
                text += "</tr>"
            }

            output.push('</tbody></table>')
        } catch(err) {
            var ex = {
                exception: err,
                output: output
            }
            throw ex;
        }
    }

    openModal = function(uuid) {
        myModal.hide();
        var modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = modalData[uuid];
        // Open the modal
        myModal.show();
    }

    // This function will read the file into memory and then start dumping it
    function dumpFile(file)
    {
        // clear any data currently being displayed as we parse this next file
        document.getElementById('dropZone').innerHTML = '';
        $('#status').removeClass('alert-warning alert-success alert-danger').addClass('alert-info');
        $('#warnings').empty();
        modalData = {};
        document.getElementById('statusText').innerHTML = 'Status: Loading file, please wait..';

        var reader = new FileReader();
        reader.onload = function(file) {
            var arrayBuffer = reader.result;
            // Here we have the file data as an ArrayBuffer.  dicomParser requires as input a
            // Uint8Array so we create that here
            var byteArray = new Uint8Array(arrayBuffer);
            var kb = byteArray.length / 1024;
            var mb = kb / 1024;
            var byteStr = mb > 1 ? mb.toFixed(3) + " MB" : kb.toFixed(0) + " KB";
            document.getElementById('statusText').innerHTML = 'Status: Parsing ' + byteStr + ' bytes, please wait..';
            // set a short timeout to do the parse so the DOM has time to update itself with the above message
            setTimeout(function() {

                // Invoke the paresDicom function and get back a DataSet object with the contents
                var dataSet;
                try {
                    var start = new Date().getTime();
                    dataSet = dicomParser.parseDicom(byteArray);
                    // Here we call dumpDataSet to recursively iterate through the DataSet and create an array
                    // of strings of the contents.
                    var output = [];
                    dumpDataSet(dataSet, output);

                    // Combine the array of strings into one string and add it to the DOM
                    document.getElementById('dropZone').innerHTML =  output.join('');

                    var end = new Date().getTime();
                    var time = end - start;
                    if(dataSet.warnings.length > 0)
                    {
                        $('#status').removeClass('alert-success alert-info alert-danger').addClass('alert-warning');
                        $('#statusText').html('Status: Warnings encountered while parsing file (file of size '+ byteStr + ' parsed in ' + time + 'ms)');

                        dataSet.warnings.forEach(function(warning) {
                            $("#warnings").append('<li>' + warning +'</li>');
                        });
                    }
                    else
                    {
                        var pixelData = dataSet.elements.x7fe00010;
                        if(pixelData) {
                            $('#status').removeClass('alert-warning alert-info alert-danger').addClass('alert-success');
                            $('#statusText').html('Status: Ready (file of size '+ byteStr + ' parsed in ' + time + 'ms)');
                        }
                        else
                        {
                            $('#status').removeClass('alert-warning alert-info alert-danger').addClass('alert-success');
                            $('#statusText').html('Status: Ready - no pixel data found (file of size ' + byteStr + ' parsed in ' + time + 'ms)');
                        }
                    }


                }
                catch(err)
                {
                    var message = err;
                    if(err.exception) {
                        message = err.exception;
                    }

                    $('#status').removeClass('alert-success alert-info alert-warning').addClass('alert-danger');
                    document.getElementById('statusText').innerHTML = 'Status: Error - ' + message + ' (file of size ' + byteStr + ' )';
                    if(err.output) {
                        document.getElementById('dropZone').innerHTML = output.join('');
                    }
                    else if(err.dataSet) {
                        var output = [];
                        dumpDataSet(err.dataSet, output);
                        document.getElementById('dropZone').innerHTML = output.join('');
                    }
                }
            },10);
        };

        reader.readAsArrayBuffer(file);
    }


    // this function gets called once the user drops the file onto the div
    function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        // Get the FileList object that contains the list of files that were dropped
        var files = evt.dataTransfer.files;

        // this UI is only built for a single file so just dump the first one
        dumpFile(files[0]);
    }

    function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    // Setup the dnd listeners.
    var dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);


</script>
</html>